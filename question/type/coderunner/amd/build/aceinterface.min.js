define(["jquery"],function(a){function b(b,c){var d=a(document.getElementById(b)),e=parseInt(d.css("height")),f=parseInt(d.css("width")),g=d[0]===document.activeElement;this.HANDLE_SIZE=6,this.MIN_WIDTH=300,this.MIN_HEIGHT=100,this.editNode=a("<div></div>"),this.wrapperNode=a("<div id='"+b+"_wrapper' class='ace_wrapper'></div>"),this.editor=null,this.contents_changed=!1,this.hLast=e-this.HANDLE_SIZE,this.wLast=f-this.HANDLE_SIZE,this.textarea=d,this.capturingTab=!0,this.clickInProgress=!1,this.wrapperNode.css({resize:"both",overflow:"hidden",height:e,width:f,minWidth:this.MIN_WIDTH,minHeight:this.MIN_HEIGHT}),this.editNode.css({resize:"none",height:e-this.HANDLE_SIZE,width:f-this.HANDLE_SIZE}),d.after(this.wrapperNode),this.wrapperNode.append(this.editNode),this.editor=window.ace.edit(this.editNode.get(0)),d.prop("readonly")&&this.editor.setReadOnly(!0),this.editor.setOptions({enableBasicAutocompletion:!0,newLineMode:"unix"}),this.editor.$blockScrolling=1/0,this.reload(c),this.setEventHandlers(d),this.captureTab(),a(".ace_gutter").addClass("moodle-has-zindex"),d.hide(),g&&(this.editor.focus(),this.editor.navigateFileEnd())}b.prototype.captureTab=function(){this.capturingTab=!0,this.editor.commands.bindKeys({Tab:"indent","Shift-Tab":"outdent"})},b.prototype.releaseTab=function(){this.capturingTab=!1,this.editor.commands.bindKeys({Tab:null,"Shift-Tab":null})},b.prototype.setEventHandlers=function(){var a=this.wrapperNode.parent(),b=9,c=27,d=77;this.editor.getSession().on("change",function(){this.textarea.val(this.editor.getSession().getValue()),this.contents_changed=!0}.bind(this)),this.editor.on("blur",function(){this.contents_changed&&this.textarea.trigger("change")}.bind(this)),a.get(0).onmousemove=function(){var a=this.wrapperNode.outerHeight(),b=this.wrapperNode.outerWidth();a==this.hLast&&b==this.wLast||(this.editNode.outerHeight(a-this.HANDLE_SIZE),this.editNode.outerWidth(b-this.HANDLE_SIZE),this.editor.resize(),this.hLast=a,this.wLast=b)}.bind(this);var e=this;this.editor.on("mousedown",function(){e.clickInProgress=!0}),this.editor.on("focus",function(){e.clickInProgress?e.captureTab():e.releaseTab()}),this.editor.on("click",function(){e.clickInProgress=!1}),this.editor.container.addEventListener("keydown",function(a){void 0!==a.which&&0===a.which||(a.keyCode===d&&a.ctrlKey&&!a.altKey?(e.capturingTab?e.releaseTab():e.captureTab(),a.preventDefault()):a.keyCode===c?e.releaseTab():a.shiftKey||a.ctrlKey||a.altKey||a.keyCode==b||e.captureTab())},!0)},b.prototype.close=function(){var a=this.editor.isFocused();this.textarea.val(this.editor.getSession().getValue()),this.editor.destroy(),this.wrapperNode.remove(),this.textarea.show(),a&&(this.textarea.focus(),this.textarea[0].selectionStart=this.textarea[0].value.length)},b.prototype.reload=function(a){var b=this.editor.getSession();b.setValue(this.textarea.val()),a&&b.setMode(a.mode)};var c=function(){this.editableFields={},this.activeEditors={},this.modelist=window.ace.require("ace/ext/modelist"),window.ace.require("ace/ext/language_tools");var b=this;a(document.body).on("keydown",function(a){var c=77;a.keyCode===c&&a.ctrlKey&&a.altKey&&(0===Object.keys(b.activeEditors).length?b.startUsingAce():b.stopUsingAce())})};return c.prototype.findMode=function(a){var b,c,d,e=[];"octave"===a.toLowerCase()?a="matlab":"nodejs"===a.toLowerCase()&&(a="javascript"),e=[a,a.replace(/\d*$/,"")];for(var f=0;f<e.length;f++)if(b=e[f],c="input."+b,d=this.modelist.modesByName[b]||this.modelist.modesByName[b.toLowerCase()]||this.modelist.getModeForPath(c)||this.modelist.getModeForPath(c.toLowerCase()),d&&"text"!==d.name)return d},c.prototype.initAce=function(a,c){var d=this.findMode(c);this.editableFields[a]=c,this.activeEditors[a]?this.activeEditors[a].reload(d):this.activeEditors[a]=new b(a,d)},c.prototype.stopUsingAce=function(){for(var a in this.activeEditors)this.activeEditors[a].close();this.activeEditors={}},c.prototype.startUsingAce=function(){for(var a in this.editableFields)this.initAce(a,this.editableFields[a])},new c});